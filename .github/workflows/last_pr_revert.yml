name: Revert Last Merged PR

on:
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

jobs:
  revert_last_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 10  # Ensures we get commit history for checking merges

      - name: Get Last Merged Commit
        run: |
          LAST_MERGE_COMMIT=$(git log --merges --pretty=format:"%H" -n 1)
          if [ -z "$LAST_MERGE_COMMIT" ]; then
            echo "No merge commits found! Exiting..."
            exit 1
          fi
          echo "LAST_MERGE_COMMIT=$LAST_MERGE_COMMIT" >> $GITHUB_ENV

      - name: Revert Last Merged Commit
        run: |
          echo "🔄 Reverting last merged PR: $LAST_MERGE_COMMIT"
          
          # Ensure we are on the latest main branch
          git checkout main
          git pull origin main --rebase
          
          # Revert the merge commit (-m 1 specifies the main branch as the parent)
          git revert -m 1 $LAST_MERGE_COMMIT || { echo "❌ Revert failed!"; exit 1; }

          echo "✅ Revert successful."

      - name: Push Changes
        run: |
          echo "🚀 Pushing revert commit..."
          git remote set-url origin https://$GH_PAT@github.com/Sprayer1122/github-actions-demo.git
          git push origin main
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
